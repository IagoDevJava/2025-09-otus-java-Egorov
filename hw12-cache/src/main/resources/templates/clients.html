<!DOCTYPE html>
<html lang="ru" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Клиенты</title>
    <style>
        table {
            border-collapse: collapse;
            margin: 20px 0;
            width: 100%;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            cursor: pointer;
        }
        .success-message {
            color: green;
            font-weight: bold;
            margin: 10px 0;
            padding: 10px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            display: none;
        }
        .error-message {
            color: red;
            font-weight: bold;
            margin: 10px 0;
            padding: 10px;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            display: none;
        }
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
    </style>
</head>

<body>
<h2>Список клиентов</h2>

<!-- Убрали блок .cache-info -->

<div id="successMessage" class="success-message"></div>
<div id="errorMessage" class="error-message"></div>

<div id="clientsTableContainer">
    <table>
        <thead>
        <tr>
            <th style="width: 50px">ID</th>
            <th style="width: 200px">Имя</th>
            <th style="width: 200px">Адрес</th>
            <th style="width: 200px">Телефоны</th>
        </tr>
        </thead>
        <tbody>
        <#if clients??>
        <#list clients as client>
        <tr>
            <td>${client.id!""}</td>
            <td>${client.name!""}</td>
            <td>
                <#if client.address??>
                ${client.address.street!""}
                <#else>
                -
            </#if>
            </td>
            <td>
                <#if client.phones??>
                <#list client.phones as phone>
                ${phone.number!""}<#if phone_has_next>, </#if>
        </#list>
        <#else>
        -
        </#if>
        </td>
        </tr>
    </#list>
    <#else>
    <tr>
        <td colspan="4" style="text-align: center">Нет клиентов</td>
    </tr>
</#if>
</tbody>
</table>
</div>

<h3>Создать клиента</h3>
<form id="createClientForm" onsubmit="createClient(event)">
    <div class="form-group">
        <label>Имя *</label>
        <input type="text" id="name" placeholder="Имя клиента" required>
    </div>

    <div class="form-group">
        <label>Адрес (улица)</label>
        <input type="text" id="street" placeholder="Улица">
    </div>

    <div class="form-group">
        <label>Телефоны (через запятую)</label>
        <input type="text" id="phones" placeholder="+7-111-111-11-11, +7-222-222-22-22">
    </div>

    <button type="submit">Создать</button>
</form>

<script>
    // Загрузка списка клиентов
    function loadClients() {
        fetch('clients/')
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const tableContainer = doc.getElementById('clientsTableContainer');

                if (tableContainer) {
                    document.getElementById('clientsTableContainer').innerHTML = tableContainer.innerHTML;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('Ошибка при загрузке списка клиентов');
            });
    }

    // Создание клиента
    function createClient(event) {
        event.preventDefault();

        const phonesInput = document.getElementById('phones').value;
        const phonesArray = phonesInput.split(',').map(p => p.trim()).filter(p => p.length > 0);

        const formData = {
            name: document.getElementById('name').value,
            address: {
                street: document.getElementById('street').value
            },
            phones: phonesArray.map(number => ({ number: number }))
        };

        // Если street пустой, не отправляем address
        if (!formData.address.street) {
            delete formData.address;
        }

        // Если phones пустой, не отправляем phones
        if (formData.phones.length === 0) {
            delete formData.phones;
        }

        fetch('clients/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error || 'Ошибка при создании клиента'); });
            }
            return response.json();
        })
        .then(data => {
            showSuccess('Клиент успешно создан!');
            document.getElementById('createClientForm').reset();
            loadClients();
        })
        .catch(error => {
            console.error('Error:', error);
            showError(error.message || 'Ошибка при создании клиента');
        });
    }

    function showSuccess(message) {
        const successDiv = document.getElementById('successMessage');
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        setTimeout(() => { successDiv.style.display = 'none'; }, 3000);
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => { errorDiv.style.display = 'none'; }, 5000);
    }
</script>
</body>
</html>